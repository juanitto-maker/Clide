# ============================================
# Lynis Security Audit Skill
# ============================================
# Connects to a remote server via SSH, installs Lynis if not present,
# runs a full system security audit, and reports the Hardening Index score,
# top warnings, and actionable suggestions.
#
# Mirrors the pattern used by vps_hardening.yaml — SSH-only, no branching.
#
# Usage:
#   run_skill lynis_audit vps_host=1.2.3.4 vps_user=root
#   run_skill lynis_audit vps_host=100.x.x.x vps_user=juanitto ssh_key=~/.ssh/id_ed25519

name: lynis_audit
description: >
  Install Lynis on a remote server (if not present) and run a full security
  audit via SSH. Reports the Hardening Index score, top warnings, and
  actionable suggestions. Use after vps_hardening to verify your score.
version: "1.1.0"
author: digitalAIventures LLC
tags:
  - security
  - audit
  - lynis
  - hardening
  - vps

parameters:
  vps_host:
    description: VPS IP address or hostname to audit (Tailscale or public IP).
    type: string
    required: true

  vps_user:
    description: SSH username on the remote server.
    type: string
    required: false
    default: "root"

  ssh_key:
    description: Path to local SSH private key.
    type: string
    required: false
    default: "~/.ssh/id_ed25519"

commands:
  # ── 0. Verify SSH connectivity ────────────────────────────────────────────
  - 'ssh -i {{ssh_key}} -o StrictHostKeyChecking=accept-new -o ConnectTimeout=15 -o BatchMode=yes {{vps_user}}@{{vps_host}} "echo Connected as $(whoami) on $(hostname)"'

  # ── 1. Install Lynis if not already present ───────────────────────────────
  - >-
    ssh -i {{ssh_key}} -o StrictHostKeyChecking=accept-new -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "command -v lynis >/dev/null 2>&1
    && echo '[1] lynis already installed'
    || (DEBIAN_FRONTEND=noninteractive sudo apt-get install -y lynis 2>/dev/null
        || sudo yum install -y lynis 2>/dev/null
        || sudo dnf install -y lynis 2>/dev/null)
    && echo '[1] lynis installed'"

  # ── 2. Run full audit (quiet mode, captures log) ──────────────────────────
  - >-
    ssh -i {{ssh_key}} -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "echo '[2] Running lynis audit system — this takes 60-120 seconds...'
    && sudo lynis audit system --quiet 2>&1 | tail -5
    && echo '[2] Audit complete'"

  # ── 3. Report: Hardening Index + Warnings ─────────────────────────────────
  - >-
    ssh -i {{ssh_key}} -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "echo ''
    && echo '============================================'
    && echo '  LYNIS AUDIT RESULTS: {{vps_host}}'
    && echo '============================================'
    && echo ''
    && echo '--- Hardening Index ---'
    && (sudo grep 'Hardening index' /var/log/lynis.log 2>/dev/null | tail -1
        || echo '  (check /var/log/lynis.log manually)')
    && echo ''
    && echo '--- Warnings (top 20) ---'
    && (sudo grep '^warning\[\]' /var/log/lynis-report.dat 2>/dev/null
        | sed 's/warning\[\]=/  W: /' | head -20
        || echo '  None found in report.dat — check /var/log/lynis.log')
    && echo ''"

  # ── 4. Report: Top Suggestions ────────────────────────────────────────────
  - >-
    ssh -i {{ssh_key}} -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "echo '--- Top Suggestions (top 25) ---'
    && (sudo grep '^suggestion\[\]' /var/log/lynis-report.dat 2>/dev/null
        | sed 's/suggestion\[\]=/  S: /' | head -25
        || echo '  None found in report.dat — check /var/log/lynis.log')
    && echo ''
    && echo '--- Files ---'
    && echo '  Full log:    /var/log/lynis.log'
    && echo '  Report data: /var/log/lynis-report.dat'
    && echo ''
    && echo '[Done] Tip: run vps_hardening to address warnings and raise your score.'"

rollback_command:
  - echo "No rollback needed — lynis_audit is read-only."

require_confirmation: false
parallel: false
retry_count: 0
timeout: 300

# ============================================
# Notes
# ============================================
# - Hardening Index ranges 0-100. Score 70+ is good; 80+ is excellent.
# - After running vps_hardening, rerun this skill to confirm score improved.
# - For SSH access, vps_hardening must have already set up key-based auth.
# - timeout: 300s (5 min) — lynis typically finishes in 60-120s on a VPS.
