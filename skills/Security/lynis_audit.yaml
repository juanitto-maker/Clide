# ============================================
# Lynis Security Audit Skill
# ============================================
# Installs Lynis (if not already present) and runs a full system security
# audit. Reports the Hardening Index score, top warnings, and actionable
# suggestions. Works on the local machine or on a remote host via SSH.
#
# Usage (local):
#   run_skill lynis_audit
#
# Usage (remote VPS):
#   run_skill lynis_audit remote_host=1.2.3.4 ssh_user=root
#   run_skill lynis_audit remote_host=100.x.x.x ssh_user=juanitto ssh_key=~/.ssh/id_ed25519

name: lynis_audit
description: >
  Install Lynis (if not present) and run a full security audit.
  Displays the Hardening Index score, top warnings, and actionable suggestions.
  Supports local execution or remote via SSH (VPS/server).
version: "1.0.0"
author: digitalAIventures LLC
tags:
  - security
  - audit
  - lynis
  - hardening
  - vps

parameters:
  remote_host:
    description: >
      Remote host IP or hostname to audit via SSH.
      Leave empty (default) to audit the local machine.
    type: string
    required: false
    default: ""

  ssh_user:
    description: SSH username for the remote host.
    type: string
    required: false
    default: "root"

  ssh_key:
    description: Path to SSH private key for the remote host.
    type: string
    required: false
    default: "~/.ssh/id_ed25519"

  show_suggestions:
    description: >
      Show Lynis suggestions in addition to warnings and score.
      Set to "no" to show only warnings and the hardening index.
    type: string
    required: false
    default: "yes"

commands:
  # ── 1. Install Lynis if not already present ──────────────────────────────────
  - >-
    if [ -n "{{remote_host}}" ]; then
    ssh -i {{ssh_key}} -o StrictHostKeyChecking=accept-new -o BatchMode=yes
    -o ConnectTimeout=15 {{ssh_user}}@{{remote_host}}
    "command -v lynis >/dev/null 2>&1
    || { sudo apt-get install -y lynis 2>/dev/null
         || sudo yum install -y lynis 2>/dev/null
         || sudo dnf install -y lynis 2>/dev/null
         || true; };
    echo [1] lynis ready on {{remote_host}}";
    else
    command -v lynis >/dev/null 2>&1
    || { sudo apt-get install -y lynis 2>/dev/null
         || sudo yum install -y lynis 2>/dev/null
         || pkg install lynis 2>/dev/null
         || true; };
    echo "[1] lynis ready (local)";
    fi

  # ── 2. Run full audit and display Hardening Index score ─────────────────────
  - >-
    if [ -n "{{remote_host}}" ]; then
    ssh -i {{ssh_key}} -o BatchMode=yes {{ssh_user}}@{{remote_host}}
    "echo ''; echo '===== LYNIS AUDIT — {{remote_host}} =====';
    sudo lynis audit system --quiet 2>/dev/null | tail -3;
    echo '';
    echo '--- Hardening Index ---';
    sudo grep 'Hardening index' /var/log/lynis.log 2>/dev/null | tail -1
    || sudo grep 'Hardening index' /var/log/lynis-report.dat 2>/dev/null | tail -1
    || echo 'Run complete — check /var/log/lynis.log for score';
    echo '--- Warnings ---';
    sudo grep '^warning\[\]' /var/log/lynis-report.dat 2>/dev/null
    | sed 's/warning\[\]=/  W: /' | head -20
    || sudo grep 'Warning' /var/log/lynis.log 2>/dev/null | tail -20";
    else
    echo ''; echo '===== LYNIS AUDIT — local =====';
    sudo lynis audit system --quiet 2>/dev/null | tail -3;
    echo '';
    echo '--- Hardening Index ---';
    sudo grep 'Hardening index' /var/log/lynis.log 2>/dev/null | tail -1
    || sudo grep 'Hardening index' /var/log/lynis-report.dat 2>/dev/null | tail -1
    || echo 'Run complete — check /var/log/lynis.log for score';
    echo '--- Warnings ---';
    sudo grep '^warning\[\]' /var/log/lynis-report.dat 2>/dev/null
    | sed 's/warning\[\]=/  W: /' | head -20
    || sudo grep 'Warning' /var/log/lynis.log 2>/dev/null | tail -20;
    fi

  # ── 3. Show suggestions (if show_suggestions=yes) ───────────────────────────
  - >-
    if [ "{{show_suggestions}}" = "yes" ]; then
    if [ -n "{{remote_host}}" ]; then
    ssh -i {{ssh_key}} -o BatchMode=yes {{ssh_user}}@{{remote_host}}
    "echo '--- Top Suggestions ---';
    sudo grep '^suggestion\[\]' /var/log/lynis-report.dat 2>/dev/null
    | sed 's/suggestion\[\]=/  S: /' | head -25
    || sudo grep 'Suggestion' /var/log/lynis.log 2>/dev/null | tail -25";
    else
    echo '--- Top Suggestions ---';
    sudo grep '^suggestion\[\]' /var/log/lynis-report.dat 2>/dev/null
    | sed 's/suggestion\[\]=/  S: /' | head -25
    || sudo grep 'Suggestion' /var/log/lynis.log 2>/dev/null | tail -25;
    fi; fi

  # ── 4. Print full report path ────────────────────────────────────────────────
  - >-
    if [ -n "{{remote_host}}" ]; then
    ssh -i {{ssh_key}} -o BatchMode=yes {{ssh_user}}@{{remote_host}}
    "echo '';
    echo '[4] Audit complete. Full report: /var/log/lynis.log';
    echo '    Report data:  /var/log/lynis-report.dat'";
    else
    echo '';
    echo '[4] Audit complete. Full report: /var/log/lynis.log';
    echo '    Report data:  /var/log/lynis-report.dat';
    fi

rollback_command:
  - echo "No rollback needed — lynis_audit is a read-only audit skill."

require_confirmation: false
parallel: false
retry_count: 0
timeout: 300

# ============================================
# Notes
# ============================================
# - lynis audit system can take 60-120 seconds on a typical VPS.
# - The Hardening Index ranges from 0-100. A score of 70+ is generally good.
# - After running vps_hardening, use this skill to verify your score improved.
# - For remote hosts, ensure SSH key auth is configured (vps_hardening sets this up).
# - Full lynis log: /var/log/lynis.log
# - Machine-readable report: /var/log/lynis-report.dat
