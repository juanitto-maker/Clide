# ============================================
# Lynis Security Audit Skill
# ============================================
# Runs a full Lynis security audit on a remote VPS via SSH.
# Installs Lynis on the remote server if not already present.
# Reports the Hardening Index score, top warnings, and suggestions.
#
# Note: Lynis is not available in Termux repositories and cannot be
# run locally on this device. Use mode=ssh to audit a remote VPS.
#
# Usage:
#   run_skill lynis_audit mode=ssh vps_host=1.2.3.4
#   run_skill lynis_audit mode=ssh vps_host=100.x.x.x vps_user=juanitto

name: lynis_audit
description: >
  Run a Lynis security audit on a remote VPS via SSH. Installs Lynis if
  not present. Reports the Hardening Index score, top warnings, and
  actionable suggestions. Use after vps_hardening to verify your score.
  Note: local mode is not supported (Lynis is unavailable in Termux repos).
version: "1.3.0"
author: digitalAIventures LLC
tags:
  - security
  - audit
  - lynis
  - hardening
  - vps

parameters:
  mode:
    description: >
      Audit mode. Only 'ssh' is supported — Lynis is not available in
      Termux repositories and cannot be run locally on this device.
    type: string
    required: false
    default: "ssh"

  vps_host:
    description: VPS IP address or hostname to audit (Tailscale or public IP).
    type: string
    required: true

  vps_user:
    description: SSH username on the remote server.
    type: string
    required: false
    default: "root"

  ssh_key:
    description: Path to local SSH private key.
    type: string
    required: false
    default: "~/.ssh/id_ed25519"

commands:
  # ── 0. Mode guard ─────────────────────────────────────────────────────────
  # Local mode is blocked: Lynis is not in Termux repos.
  - >-
    if [ "{{mode}}" = "local" ]; then
    echo "Lynis cannot be installed directly in Termux as it's not available in the default repositories. Therefore, I'm unable to run the Lynis audit locally."
    && exit 1;
    else
    echo "[0] lynis_audit mode=ssh — target: {{vps_user}}@{{vps_host}}";
    fi

  # ── 1. Verify SSH + install Lynis if not present ──────────────────────────
  - >-
    ssh -i {{ssh_key}} -o StrictHostKeyChecking=accept-new -o BatchMode=yes
    -o ConnectTimeout=15 {{vps_user}}@{{vps_host}}
    "command -v lynis >/dev/null 2>&1
    && echo '[1] lynis already installed'
    || (DEBIAN_FRONTEND=noninteractive sudo apt-get install -y lynis 2>/dev/null
    || sudo yum install -y lynis 2>/dev/null
    || sudo dnf install -y lynis 2>/dev/null)
    && echo '[1] lynis installed'"

  # ── 2. Run full audit ─────────────────────────────────────────────────────
  - >-
    ssh -i {{ssh_key}} -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "echo '[2] Running lynis audit system on {{vps_host}} (60-120s)...'
    && sudo lynis audit system --quiet 2>&1 | tail -5
    && echo '[2] Audit complete'"

  # ── 3. Hardening Index + Warnings ────────────────────────────────────────
  - >-
    ssh -i {{ssh_key}} -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "echo ''
    && echo '============================================'
    && echo '  LYNIS AUDIT RESULTS: {{vps_host}}'
    && echo '============================================'
    && echo ''
    && echo '--- Hardening Index ---'
    && (sudo grep 'Hardening index' /var/log/lynis.log 2>/dev/null | tail -1
    || echo '  (check /var/log/lynis.log)')
    && echo ''
    && echo '--- Warnings (top 20) ---'
    && (sudo grep '^warning\[\]' /var/log/lynis-report.dat 2>/dev/null
    | sed 's/warning\[\]=/  W: /' | head -20
    || echo '  none found')
    && echo ''"

  # ── 4. Top Suggestions ────────────────────────────────────────────────────
  - >-
    ssh -i {{ssh_key}} -o BatchMode=yes {{vps_user}}@{{vps_host}}
    "echo '--- Suggestions (top 25) ---'
    && (sudo grep '^suggestion\[\]' /var/log/lynis-report.dat 2>/dev/null
    | sed 's/suggestion\[\]=/  S: /' | head -25
    || echo '  none found')
    && echo ''
    && echo '[Done] Full log: /var/log/lynis.log'"

rollback_command:
  - echo "No rollback needed — lynis_audit is read-only."

require_confirmation: false
parallel: false
retry_count: 0
timeout: 300

# ============================================
# Notes
# ============================================
# - Hardening Index: 0-100. Score 70+ = good, 80+ = excellent.
# - Lynis is unavailable in Termux pkg repos — SSH to a VPS to audit.
# - mode=ssh requires SSH key auth. vps_hardening sets this up.
# - timeout: 300s (5 min). Lynis typically finishes in 60-120s on a VPS.
# - After vps_hardening, rerun this skill to confirm your score improved.
