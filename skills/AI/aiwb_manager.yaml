# ============================================
# AIWB Manager Skill
# ============================================
# Drives AIworkbench (AIWB) in headless mode from Clide.
# Invokes the /make, /tweak, or /debug pipeline without any
# interactive TUI — ideal for bot automation and CI workflows.
#
# Prerequisites:
#   - AIWB is auto-installed on first run if not already present
#   - API keys are injected automatically from ~/.clide/secrets.yaml
#     (no manual key setup needed — just run the skill)
#
# Usage examples:
#   run_skill aiwb_manager prompt="Add JWT auth to this FastAPI app" context="./src/"
#   run_skill aiwb_manager prompt="Fix the failing test in tests/test_api.py" mode=debug
#   run_skill aiwb_manager prompt="Refactor the handler to use dataclasses" mode=tweak model=gemini:gemini-2.5-flash verifier=claude:auto
#   run_skill aiwb_manager prompt="Write a Dockerfile for a Python FastAPI app" output=/tmp/result.md
# ============================================

name: aiwb_manager
description: >
  Drive AIworkbench (AIWB) make/tweak/debug pipeline in headless mode
  from Clide. Auto-installs AIWB on first run and injects API keys from
  Clide secrets automatically. Generates AI output via a
  Generator-Verifier loop without any interactive TUI prompts. Supports
  multi-provider routing and optional cross-provider verification.
version: "1.1.0"
author: Clide Team
tags:
  - ai
  - code-generation
  - automation
  - aiwb
  - headless
  - generator-verifier

parameters:
  prompt:
    description: >
      The instruction text — what you want AIWB to make, tweak, or debug.
      Can be multiple sentences. Passed as --instruct via a temp file to
      avoid shell quoting issues.
    type: string
    required: true

  mode:
    description: "AIWB workflow mode: make (create new) | tweak (improve existing) | debug (diagnose)"
    type: string
    required: false
    default: "make"

  model:
    description: >
      Generator model in provider:model-name format.
      e.g. gemini:gemini-2.5-flash, claude:claude-sonnet-4-5-20250929, openai:gpt-4o
      Omit to use the AIWB configured default.
    type: string
    required: false
    default: ""

  verifier:
    description: >
      Verifier model in provider:model-name format, or "auto" for cross-provider
      verification (recommended), or "none" to skip verification.
      e.g. claude:auto, gemini:auto, auto, none
    type: string
    required: false
    default: "auto"

  context:
    description: >
      Comma-separated list of files or directories to include as context.
      e.g. "./src/,./tests/,./README.md"
      Omit if no additional context is needed.
    type: string
    required: false
    default: ""

  output:
    description: >
      Path to copy the generated output .md file into after completion.
      e.g. /tmp/aiwb-result.md
      Omit to leave output only in the AIWB workspace (~/.aiwb/workspace/outputs/).
    type: string
    required: false
    default: ""

commands:
  # ── 0. PRE-FLIGHT — auto-install aiwb if missing, verify it works ─────────
  # Clones AIworkbench and runs its installer when aiwb is not on PATH.
  # Also ensures ~/.local/bin is in PATH without duplicating the entry.
  - >-
    export PATH="$HOME/.local/bin:$PATH" &&
    if ! command -v aiwb >/dev/null 2>&1; then
      echo "[0] aiwb not found — auto-installing from AIworkbench..." &&
      AIWB_SRC="$HOME/AIworkbench" &&
      if [ ! -d "$AIWB_SRC" ]; then
        git clone --depth=1 https://github.com/juanitto-maker/AIworkbench.git "$AIWB_SRC" 2>&1 | tail -5 || true;
      else
        echo "   Source already at $AIWB_SRC — updating..." &&
        git -C "$AIWB_SRC" pull --ff-only origin main 2>/dev/null || true;
      fi &&
      bash "$AIWB_SRC/install.sh" &&
      if ! grep -q '\.local/bin' "$HOME/.bashrc" 2>/dev/null; then
        printf '\nexport PATH="$HOME/.local/bin:$PATH"\n' >> "$HOME/.bashrc" &&
        echo "   Added ~/.local/bin to ~/.bashrc PATH";
      else
        echo "   ~/.local/bin already in ~/.bashrc PATH — no duplicate added";
      fi;
    fi &&
    export PATH="$HOME/.local/bin:$PATH" &&
    if ! command -v aiwb >/dev/null 2>&1; then
      echo "ERROR: aiwb install failed. Check $HOME/AIworkbench output above." &&
      exit 1;
    fi &&
    echo "[0] aiwb ready: $(command -v aiwb)" &&
    aiwb --version 2>/dev/null || true

  # ── 0b. CONFIGURE API KEYS — injected from Clide secrets, never logged ────
  # ${KEY_NAME} placeholders are substituted by Clide's skill executor at
  # runtime from ~/.clide/secrets.yaml — the values never reach the AI model.
  # Empty placeholders (key not configured in secrets) are silently skipped.
  - >-
    export PATH="$HOME/.local/bin:$PATH" &&
    AIWB_ENV="$HOME/.aiwb/workspace/.aiwb.env" &&
    mkdir -p "$(dirname "$AIWB_ENV")" &&
    touch "$AIWB_ENV" && chmod 600 "$AIWB_ENV" &&
    _write_key() {
      local k="$1" v="$2";
      [ -z "$v" ] && return 0;
      if grep -q "^${k}=" "$AIWB_ENV" 2>/dev/null; then
        sed -i "s|^${k}=.*|${k}=${v}|" "$AIWB_ENV";
      else
        printf '%s=%s\n' "$k" "$v" >> "$AIWB_ENV";
      fi;
    } &&
    _write_key GEMINI_API_KEY    "${GEMINI_API_KEY}"    &&
    _write_key ANTHROPIC_API_KEY "${ANTHROPIC_API_KEY}" &&
    _write_key OPENAI_API_KEY    "${OPENAI_API_KEY}"    &&
    _write_key GROQ_API_KEY      "${GROQ_API_KEY}"      &&
    _write_key XAI_API_KEY       "${XAI_API_KEY}"       &&
    KEYS_SET=$(grep -c '=.\+' "$AIWB_ENV" 2>/dev/null || echo 0) &&
    echo "[0b] $KEYS_SET API key(s) configured in aiwb env"

  # ── 1. WRITE PROMPT TO TEMP FILE — avoids shell quoting issues ────────────
  # Filename is mode-scoped (not PID-based) so all commands share it even
  # when the skill runner spawns each command in a fresh shell.
  # Prefers $TMPDIR (set on Termux/macOS), falls back to $HOME/.clide/tmp
  # so we never touch /tmp (which can be read-only on some platforms).
  - >-
    CLIDE_TMP="${TMPDIR:-$HOME/.clide/tmp}" &&
    mkdir -p "$CLIDE_TMP" &&
    AIWB_PROMPT_FILE="$CLIDE_TMP/clide-aiwb-prompt-{{mode}}.md" &&
    printf '%s' '{{prompt}}' > "$AIWB_PROMPT_FILE" &&
    echo "[1] Prompt written to: $AIWB_PROMPT_FILE" &&
    echo "    $(wc -c < "$AIWB_PROMPT_FILE") bytes, mode: {{mode}}"

  # ── 2. BUILD AND RUN HEADLESS COMMAND ─────────────────────────────────────
  # When no output path is given, default to ~/clide_exports/ so Clide can
  # automatically deliver the file as a Telegram download attachment.
  - >-
    export PATH="$HOME/.local/bin:$PATH" &&
    CLIDE_TMP="${TMPDIR:-$HOME/.clide/tmp}" &&
    AIWB_PROMPT_FILE="$CLIDE_TMP/clide-aiwb-prompt-{{mode}}.md" &&
    AIWB_VERIFIER="{{verifier}}" &&
    if [ -n "{{output}}" ]; then
      AIWB_OUT="{{output}}";
    else
      AIWB_OUT="$HOME/clide_exports/aiwb_output.md";
    fi &&
    mkdir -p "$(dirname "$AIWB_OUT")" &&
    AIWB_CMD="aiwb headless --mode {{mode}} --instruct $AIWB_PROMPT_FILE --output $AIWB_OUT" &&
    if [ -n "{{model}}" ]; then
      AIWB_CMD="$AIWB_CMD --model {{model}}";
    fi &&
    if [ "${AIWB_VERIFIER}" != "none" ] && [ -n "${AIWB_VERIFIER}" ]; then
      AIWB_CMD="$AIWB_CMD --verifier ${AIWB_VERIFIER}";
    fi &&
    if [ -n "{{context}}" ]; then
      AIWB_CMD="$AIWB_CMD --context {{context}}";
    fi &&
    echo "[2] Running: $AIWB_CMD" &&
    echo "" &&
    eval "$AIWB_CMD"

  # ── 3. CLEANUP TEMP FILE ──────────────────────────────────────────────────
  - >-
    CLIDE_TMP="${TMPDIR:-$HOME/.clide/tmp}" &&
    rm -f "$CLIDE_TMP/clide-aiwb-prompt-{{mode}}.md" &&
    echo "" &&
    echo "[3] Done. AIWB output saved to: $HOME/clide_exports/ (or custom --output path)"

rollback_command:
  - rm -f "${TMPDIR:-$HOME/.clide/tmp}/clide-aiwb-prompt-*.md"
  - echo "Cleaned up AIWB temp prompt files."

require_confirmation: false
parallel: false
retry_count: 0
timeout: 600
