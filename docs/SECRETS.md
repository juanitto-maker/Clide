# Secrets & Credential Management

This document explains how Clide handles secrets, where credentials are stored after installation, how to use the secrets file as a credential store for skills, and where to find auto-generated tokens and passwords on your system.

---

## Overview

Clide intentionally separates **configuration** from **secrets**:

| File | Purpose | Contains |
|---|---|---|
| `~/.clide/config.yaml` | App behaviour | Homeserver URLs, model names, toggles |
| `~/.clide/secrets.yaml` | Sensitive credentials | API keys, tokens, passwords |
| `~/.config/clide/config.env` | Shell environment file | Same keys as secrets.yaml in `KEY=VALUE` format |

Both `config.yaml` and `secrets.yaml` are **never committed to git** (enforced by `.gitignore`). The `secrets.yaml` file takes priority over `config.yaml`; environment variables override both.

**Priority (highest wins):**
```
environment variable  >  secrets.yaml  >  config.yaml  >  built-in default
```

---

## The Secrets File

### Location

```
~/.clide/secrets.yaml
```

### Setting up

The installer creates this file automatically. To set it up manually:

```bash
mkdir -p ~/.clide
cp /path/to/Clide/secrets.example.yaml ~/.clide/secrets.yaml
chmod 600 ~/.clide/secrets.yaml   # owner read-write only — required
```

### Structure

```yaml
# Primary AI provider
GEMINI_API_KEY: "AIzaSy..."

# Messaging
MATRIX_ACCESS_TOKEN: "syt_..."
TELEGRAM_BOT_TOKEN: "123456789:ABC..."

# Additional AI providers (used by skills)
ANTHROPIC_API_KEY: "sk-ant-..."
OPENAI_API_KEY: "sk-..."
GROQ_API_KEY: "gsk_..."
XAI_API_KEY: "xai-..."

# Custom — add anything you need
MY_VPS_ROOT_PASSWORD: "hunter2"
MY_GITHUB_TOKEN: "ghp_..."
MY_DISCORD_WEBHOOK: "https://discord.com/api/webhooks/..."
```

### How Clide loads secrets

1. On startup, Clide reads `~/.clide/config.yaml` first.
2. It then reads `~/.clide/secrets.yaml` and overlays it — matching keys overwrite the config value.
3. Environment variables are checked last and override everything.
4. All keys from `secrets.yaml` are registered as runtime variables, available as `${KEY_NAME}` in skill commands.

---

## Using Secrets in Skills

Any key in `secrets.yaml` can be referenced inside a skill YAML file using the `${KEY_NAME}` placeholder. The AI model **never sees the actual value** — substitution happens just before execution:

```yaml
# Example skill: call a private API
name: fetch_dashboard
description: "Fetch private dashboard data"
commands:
  - "curl -s -H 'Authorization: Bearer ${MY_API_TOKEN}' https://api.example.com/v1/dashboard"
  - "curl -s -u '${MY_VPS_USER}:${MY_VPS_ROOT_PASSWORD}' https://my-server.com/metrics"
```

You can add any custom key to `secrets.yaml` and reference it this way — database passwords, webhook URLs, SSH key paths, whatever your skills need.

---

## Where to Find Auto-Generated Tokens and Passwords

The installer saves every credential you enter (or that it generates on your behalf). Here is where to look for each type:

### All saved credentials at once

```bash
# Main config (tokens, API keys, platform settings)
cat ~/.clide/config.yaml

# Env file (same keys in KEY=VALUE format)
cat ~/.config/clide/config.env

# Secrets file (if you set one up separately)
cat ~/.clide/secrets.yaml
```

### Matrix access token

The Matrix access token is a bearer token that authenticates your bot to the homeserver. It is **not** a password and can be regenerated at any time.

```bash
# Saved by installer here:
grep matrix_access_token ~/.clide/config.yaml
# or
grep MATRIX_ACCESS_TOKEN ~/.config/clide/config.env
```

If you need a fresh one:

```bash
# Via API (replace USERNAME and PASSWORD with your bot account's credentials)
curl -XPOST https://matrix.org/_matrix/client/v3/login \
  -H "Content-Type: application/json" \
  -d '{"type":"m.login.password","identifier":{"type":"m.id.user","user":"USERNAME"},"password":"PASSWORD"}'
# → copy "access_token" from the JSON response

# Or via Element UI:
# Settings → Help & About → scroll to "Access Token" → click to reveal
# IMPORTANT: Do NOT click Log Out after viewing — that invalidates the token.
```

### Telegram bot token

Issued by [@BotFather](https://t.me/BotFather) when you create a bot.

```bash
# Saved by installer here:
grep telegram_bot_token ~/.clide/config.yaml
# or
grep TELEGRAM_BOT_TOKEN ~/.config/clide/config.env
```

If lost: open Telegram → @BotFather → `/mybots` → select your bot → "API Token".

### Gemini API key

```bash
grep gemini_api_key ~/.clide/config.yaml
# or
grep GEMINI_API_KEY ~/.config/clide/config.env
```

To create a new one: [aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)

### SSH keys

SSH keys are not generated by Clide — they are system-level credentials used by the SSH skill.

```bash
# List all SSH keys on the system
ls -la ~/.ssh/

# View your public key (safe to share/copy to servers)
cat ~/.ssh/id_ed25519.pub
# or for RSA keys:
cat ~/.ssh/id_rsa.pub

# The private key — never share or print this
# ~/.ssh/id_ed25519
# ~/.ssh/id_rsa
```

**Generate a new SSH key pair:**
```bash
ssh-keygen -t ed25519 -C "your@email.com"
# Saves to ~/.ssh/id_ed25519 (private) and ~/.ssh/id_ed25519.pub (public)

# Add to a remote server's authorized_keys:
ssh-copy-id user@remote-host
# or manually:
cat ~/.ssh/id_ed25519.pub | ssh user@remote-host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

**Reference the key in a Clide skill:**
```yaml
# In secrets.yaml
MY_SSH_KEY_PATH: "/home/youruser/.ssh/id_ed25519"

# In a skill
commands:
  - "ssh -i ${MY_SSH_KEY_PATH} user@server 'systemctl restart myapp'"
```

### System user password

The password for your Linux/Termux user account is set when you create the account and is not stored anywhere accessible in plaintext (it is hashed in `/etc/shadow`). Clide does not generate or store your system user password.

If you need your Matrix bot account's password for re-authentication, the installer **does not save it** — only the derived access token is stored. If you've forgotten the password, reset it on [app.element.io](https://app.element.io) → Forgot Password.

---

## Environment Variable Overrides

Every secret can also be set as an environment variable instead of in a file. This is useful for CI/CD pipelines or Docker containers:

```bash
export GEMINI_API_KEY="AIzaSy..."
export MATRIX_ACCESS_TOKEN="syt_..."
export TELEGRAM_BOT_TOKEN="123456789:..."
export ANTHROPIC_API_KEY="sk-ant-..."

clide bot
```

Or put them in your shell profile so they persist across sessions:

```bash
echo 'export GEMINI_API_KEY="AIzaSy..."' >> ~/.bashrc
source ~/.bashrc
```

---

## File Permissions Checklist

```bash
# Required: only you can read your secrets
chmod 600 ~/.clide/config.yaml
chmod 600 ~/.clide/secrets.yaml
chmod 600 ~/.config/clide/config.env

# Recommended: lock the directory itself too
chmod 700 ~/.clide
chmod 700 ~/.config/clide

# SSH keys
chmod 600 ~/.ssh/id_ed25519      # private key
chmod 644 ~/.ssh/id_ed25519.pub  # public key
chmod 700 ~/.ssh                  # directory

# Verify
ls -la ~/.clide/
ls -la ~/.ssh/
```

---

## Rotating Credentials

### Matrix access token

```bash
# Get a new token
curl -XPOST https://matrix.org/_matrix/client/v3/login \
  -H "Content-Type: application/json" \
  -d '{"type":"m.login.password","identifier":{"type":"m.id.user","user":"mybot"},"password":"yourpassword"}'

# Update config
sed -i 's|matrix_access_token:.*|matrix_access_token: "NEW_TOKEN_HERE"|' ~/.clide/config.yaml

# Restart Clide
pkill clide && clide bot &
```

### Gemini API key

1. Create a new key at [aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
2. Update `~/.clide/secrets.yaml` or `~/.clide/config.yaml`
3. Restart Clide

### Telegram bot token

Telegram bot tokens do not expire, but you can revoke and regenerate via @BotFather → `/mybots` → your bot → "Revoke current token".

---

## What the AI Can and Cannot See

Clide is designed to protect your secrets from leaking to the AI model:

| Data | Sent to Gemini | Reason |
|---|---|---|
| Your message text | Yes | Needed for interpretation |
| Command output | Yes | Needed to formulate a reply |
| `${KEY_NAME}` placeholders | Only the placeholder | Values are substituted after AI responds |
| `secrets.yaml` contents | Never | File is never read aloud or included in prompts |
| `config.yaml` contents | Never | Not included in context |

The substitution step happens in the Executor, after the AI has already generated the command string. The AI only ever sees `${MY_API_TOKEN}` — never the actual token value.

---

## Troubleshooting

**"GEMINI_API_KEY not set" error:**
```bash
grep -E 'GEMINI_API_KEY|gemini_api_key' ~/.clide/config.yaml ~/.clide/secrets.yaml ~/.config/clide/config.env 2>/dev/null
```

**"Failed to authenticate with Matrix" error:**
```bash
# Check token is saved
grep matrix_access_token ~/.clide/config.yaml
# Test token directly
curl -s "https://matrix.org/_matrix/client/v3/account/whoami" \
  -H "Authorization: Bearer $(grep matrix_access_token ~/.clide/config.yaml | awk -F'"' '{print $2}')"
```

**"Skill command failed: ${MY_SECRET} not found" error:**
- Make sure the key exists in `~/.clide/secrets.yaml`
- Key names are case-sensitive — `MY_SECRET` and `my_secret` are different
- Restart Clide after editing secrets.yaml

---

## See Also

- [config.example.yaml](../config.example.yaml) — full config reference with comments
- [secrets.example.yaml](../secrets.example.yaml) — full secrets file template
- [docs/SECURITY.md](SECURITY.md) — threat model and security hardening
- [skills/example_skill.yaml](../skills/example_skill.yaml) — skill template showing `${VARIABLE}` usage
