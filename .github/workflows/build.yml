name: Build and Release

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Build & lint on x86_64 Linux (fast, every push) ─────────────────────────
  build-linux:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: linux-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: linux-cargo-

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Upload x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: clide-linux-x86_64
          path: target/release/clide

  # ── Cross-compile for Termux ARM64 (aarch64-linux-android) ──────────────────
  build-android:
    name: Build (Android ARM64 / Termux)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: android-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: android-cargo-

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build for aarch64-linux-android (Termux)
        run: cross build --release --target aarch64-linux-android

      - name: Stage binary
        run: |
          mkdir -p dist
          cp target/aarch64-linux-android/release/clide dist/clide-aarch64
          ls -lh dist/

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: clide-aarch64
          path: dist/clide-aarch64

  # ── Publish GitHub Release on version tags ───────────────────────────────────
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-android]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: clide-linux-x86_64
          path: dist/

      - name: Download ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: clide-aarch64
          path: dist/

      - name: Rename x86_64 binary
        run: mv dist/clide dist/clide-x86_64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/clide-aarch64
            dist/clide-x86_64
          generate_release_notes: true
          body: |
            ## Install (Termux one-liner)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/juanitto-maker/Clide/main/install.sh | bash
            ```

            ## Binaries
            | File | Platform |
            |---|---|
            | `clide-aarch64` | Termux (Android ARM64) |
            | `clide-x86_64` | Linux x86_64 |

            ## Manual Termux install
            ```bash
            curl -L https://github.com/juanitto-maker/Clide/releases/download/${{ github.ref_name }}/clide-aarch64 \
              -o "$PREFIX/bin/clide" && chmod +x "$PREFIX/bin/clide"
            ```
