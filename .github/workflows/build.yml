name: Build and Release

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Build & lint on x86_64 Linux (fast, every push) ─────────────────────────
  build-linux:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: linux-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: linux-cargo-

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Upload x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: clide-linux-x86_64
          path: target/release/clide

  # ── Publish GitHub Release on version tags ───────────────────────────────────
  # Note: Android/Termux users install via the one-liner (install.sh), which
  # compiles from source on-device. Since v0.3.0 (Matrix migration) the build
  # is pure-Rust (rustls + bundled SQLite, no Java/OpenSSL) and compiles
  # cleanly on Termux without requiring a pre-built ARM64 binary.
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-linux]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: clide-linux-x86_64
          path: dist/

      - name: Rename x86_64 binary
        run: mv dist/clide dist/clide-x86_64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/clide-x86_64
          generate_release_notes: true
          body: |
            ## Install (Termux / Android)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/juanitto-maker/Clide/main/install.sh | bash
            ```
            The installer compiles Clide from source on your device (10-15 min, one-time).

            ## Install (Linux x86_64)
            ```bash
            curl -L https://github.com/juanitto-maker/Clide/releases/download/${{ github.ref_name }}/clide-x86_64 \
              -o ~/.local/bin/clide && chmod +x ~/.local/bin/clide
            ```

            ## Binary
            | File | Platform |
            |---|---|
            | `clide-x86_64` | Linux x86_64 |
